// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QuoteStatus {
  PENDING
  QUOTED
  ORDERED
  // Agrega más si lo requieres
}

enum UserRole {
  ADMIN
  USER
  // Agrega más roles si los necesitas, por ejemplo:
  // SUPERADMIN
  // MANAGER
  // ...
}

enum Channel {
  WHATSAPP
  WEB
  EMAIL
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum VersionStatus {
  DRAFT
  FINAL
}

enum ArtifactType {
  PDF
  HTML
}

enum PriceOrigin {
  AUTOMATIC
  MANUAL
  PROMO
  IMPORTED
}

enum PendingMessageStatus {
  PENDING
  PROCESSING
  DONE
  ERROR
}

model Branch {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  address   String? // si quieres almacenar la dirección de la sucursal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación inversa: una sucursal puede tener muchos usuarios
  users User[]
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  lastname  String
  username  String   @unique
  email     String   @unique
  phone     String?  @unique
  password  String
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branchId String? @db.Uuid

  branch Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)

  QuoteVersion QuoteVersion[]
}

model Customer {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  lastname  String
  email     String   @unique
  phone     String   @unique
  phoneWa   String   @unique
  location  String
  createdAt DateTime @default(now())

  quotes      Quote[]
  chatThreads ChatThread[]

  QuoteVersion QuoteVersion[]
}

model Quote {
  id          String   @id @default(uuid()) @db.Uuid
  createdAt   DateTime @default(now()) // Fecha de creación
  quoteNumber Int // Número de la cotización
  customerId  String   @db.Uuid
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  items QuoteItem[] // Relación con los items de la cotización

  status QuoteStatus @default(PENDING)

  fileKey String?

  chatThreadId String?     @db.Uuid
  chatThread   ChatThread? @relation(fields: [chatThreadId], references: [id], onDelete: SetNull)

  summary      String?
  QuoteVersion QuoteVersion[]
  Message      Message[]

  @@index([chatThreadId])
}

model QuoteItem {
  id          String  @id @default(uuid()) @db.Uuid
  description String
  ean         String?
  codigo      String?
  quantity    Float
  um          String?

  // Campos opcionales de precio/costo
  price Float? // o Decimal? si requieres mayor precisión
  cost  Float? // o Decimal?

  quoteId String @db.Uuid
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  QuoteVersionItem QuoteVersionItem[]
}

model ChatThread {
  id                String    @id @default(uuid()) @db.Uuid
  openAiThreadId    String    @unique
  clientPhoneNumber String
  status            String    @default("ACTIVE")
  createdAt         DateTime  @default(now())
  lastInteraction   DateTime? @default(now())
  location          String?

  isProcessing Boolean @default(false)

  // Relación con Customer (opcional)
  customerId String?   @db.Uuid
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Relación con mensajes
  messages Message[]
  Quote Quote[]
  PendingMessage PendingMessage[]
}


model PendingMessage {
  id String @id @default(uuid()) @db.Uuid
  chatThreadId String @db.Uuid 
  chatThread ChatThread @relation(fields: [chatThreadId], references: [id], onDelete: Cascade)

  body String
  status PendingMessageStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatThreadId,status, createdAt])
}

model QuoteVersion {
  id String @id @default(uuid()) @db.Uuid

  // vínculo al quote ORIGINAL (creado cuando el cliente inicia)
  quoteId String @db.Uuid
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // para búsquedas/analytics (sin perder el snapshot)
  customerId String?   @db.Uuid
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  versionNumber Int
  status        VersionStatus @default(FINAL)

  // parámetros congelados desde el UI
  currency     String
  taxRate      Decimal  @db.Decimal(5, 4) // ej. 0.1600
  currencyRate Decimal? @db.Decimal(12, 6)

  // totales
  subtotal      Decimal  @db.Decimal(18, 4)
  discountTotal Decimal? @db.Decimal(18, 4)
  taxTotal      Decimal  @db.Decimal(18, 4)
  grandTotal    Decimal  @db.Decimal(18, 4)

  // metadatos comerciales
  validUntil   DateTime?
  paymentTerms String?
  deliveryTime String?
  notes        String?
  summary      String?

  // vendedor que generó la versión
  sellerId String? @db.Uuid
  seller   User?   @relation(fields: [sellerId], references: [id], onDelete: SetNull)

  // “foto” inmutable del cliente al momento de la versión
  customerSnapshot Json

  pdfSentAt DateTime?

  // relaciones
  items     QuoteVersionItem[]
  artifacts QuoteArtifact[]    @relation("VersionArtifacts")
  messages  Message[] // mensajes OUTBOUND que enviaron esta versión

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([quoteId, versionNumber])
  @@index([quoteId])
  @@index([customerId])
  @@index([sellerId])
}

model QuoteVersionItem {
  id             String       @id @default(uuid()) @db.Uuid
  quoteVersionId String       @db.Uuid
  version        QuoteVersion @relation(fields: [quoteVersionId], references: [id], onDelete: Cascade)

  // opcional: rastro al item original
  quoteItemId String?    @db.Uuid
  quoteItem   QuoteItem? @relation(fields: [quoteItemId], references: [id], onDelete: SetNull)
  uiLineId    String? // id de línea del UI

  // datos congelados
  description String
  ean         String?
  codigo      String?
  um          String  @default("UNIT")

  quantity  Decimal  @db.Decimal(12, 4)
  cost      Decimal? @db.Decimal(18, 4)
  currency  String
  price     Decimal? @db.Decimal(18, 4)
  marginPct Decimal? @db.Decimal(5, 2)
  lineTotal Decimal  @db.Decimal(18, 4)

  discountPct    Decimal? @db.Decimal(5, 2)
  discountAmount Decimal? @db.Decimal(18, 4)
  taxRate        Decimal? @db.Decimal(5, 4)

  priceOrigin      PriceOrigin? @default(AUTOMATIC)
  sourceProductKey String?

  // almacén como snapshot simple (sin FK)
  warehouse   String?
  binLocation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quoteVersionId])
  @@index([quoteItemId])
}

model QuoteArtifact {
  id             String       @id @default(uuid()) @db.Uuid
  quoteVersionId String       @db.Uuid
  version        QuoteVersion @relation(name: "VersionArtifacts", fields: [quoteVersionId], references: [id], onDelete: Cascade)

  type      ArtifactType
  fileKey   String // S3 key del PDF/HTML generado
  mimeType  String?
  checksum  String?
  publicUrl String?

  createdAt DateTime @default(now())

  // mensajes OUTBOUND que enviaron este artefacto
  messages Message[]

  @@index([quoteVersionId])
  @@index([type])
}

model Message {
  id        String   @id @default(uuid()) @db.Uuid
  role      String // "user" | "assistant"
  content   String
  createdAt DateTime @default(now())

  // Conversación (ya lo tenías)
  chatThreadId String     @db.Uuid
  chatThread   ChatThread @relation(fields: [chatThreadId], references: [id], onDelete: Cascade)

  // === NUEVO: transporte/omnicanal ===
  channel           Channel   @default(WHATSAPP)
  direction         Direction @default(INBOUND)
  from              String? // E.164 emisor (inbound)
  to                String? // E.164 receptor (outbound)
  provider          String? // "TWILIO"
  providerMessageId String? // MessageSid (único si existe)
  status            String? // queued|sent|delivered|read|failed
  errorCode         String?

  // === NUEVO: vínculo con cotización oficial (cuando envías) ===
  quoteId String? @db.Uuid
  quote   Quote?  @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  quoteVersionId String?       @db.Uuid
  quoteVersion   QuoteVersion? @relation(fields: [quoteVersionId], references: [id], onDelete: SetNull)

  quoteArtifactId String?        @db.Uuid
  quoteArtifact   QuoteArtifact? @relation(fields: [quoteArtifactId], references: [id], onDelete: SetNull)

  // === NUEVO: plantillas/medios (Content API) ===
  templateCode String?
  contentSid   String?
  variables    Json? // variables de plantilla
  media        Json? // [{ type:"PDF", fileKey:"...", mimeType:"application/pdf" }]

  idempotencyKey String?

  @@index([chatThreadId, createdAt])
  @@index([providerMessageId])
  @@index([quoteId])
  @@index([quoteVersionId])
  @@index([quoteArtifactId])
  @@index([to])
}

model Counter {
  name  String @id
  value Int
}
